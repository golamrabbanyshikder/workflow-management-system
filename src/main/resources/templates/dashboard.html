<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Workflow Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link th:href="@{/css/style.css}" rel="stylesheet" type="text/css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        .stat-card {
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .chart-container {
            position: relative;
            height: 300px;
        }
        .notification-item {
            border-left: 4px solid #007bff;
            padding-left: 15px;
            margin-bottom: 10px;
        }
        .notification-item.urgent {
            border-left-color: #dc3545;
        }
        .notification-item.success {
            border-left-color: #28a745;
        }
        .clickable-card {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .clickable-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/dashboard">
                <i class="fas fa-tasks me-2"></i>Workflow System
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="/dashboard">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/workflows">Workflows</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/tasks">Tasks</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/reports">Reports</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user me-1"></i>Admin
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/admin">Admin Panel</a></li>
                            <li><a class="dropdown-item" href="/audit">Audit Logs</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="/logout">Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col-md-8">
                <h2><i class="fas fa-tachometer-alt me-2"></i>Dashboard</h2>
            </div>
            <div class="col-md-4 text-end">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary" onclick="refreshDashboard()">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                    <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#filterModal">
                        <i class="fas fa-filter me-1"></i>Filter
                    </button>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card stat-card h-100 border-primary clickable-card" onclick="navigateToPage('/workflows')">
                    <div class="card-body text-center">
                        <i class="fas fa-project-diagram fa-3x text-primary mb-3"></i>
                        <h3 class="card-title" id="totalWorkflows">0</h3>
                        <p class="card-text">Total Workflows</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card stat-card h-100 border-success clickable-card" onclick="navigateToPage('/tasks')">
                    <div class="card-body text-center">
                        <i class="fas fa-tasks fa-3x text-success mb-3"></i>
                        <h3 class="card-title" id="totalTasks">0</h3>
                        <p class="card-text">Total Tasks</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card stat-card h-100 border-warning clickable-card" onclick="navigateToPage('/tasks?status=PENDING')">
                    <div class="card-body text-center">
                        <i class="fas fa-hourglass-half fa-3x text-warning mb-3"></i>
                        <h3 class="card-title" id="pendingTasks">0</h3>
                        <p class="card-text">Pending Tasks</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card stat-card h-100 border-info clickable-card" onclick="navigateToPage('/tasks')">
                    <div class="card-body text-center">
                        <i class="fas fa-exclamation-triangle fa-3x text-info mb-3"></i>
                        <h3 class="card-title" id="overdueTasks">0</h3>
                        <p class="card-text">Overdue Tasks</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Task Status Distribution</h6>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="taskStatusChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Workflow Status</h6>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="workflowStatusChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-8 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>Task Completion Trend</h6>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="taskTrendChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-signal me-2"></i>Priority Distribution</h6>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="priorityChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activities and Notifications -->
        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-history me-2"></i>Recent Activities</h6>
                    </div>
                    <div class="card-body">
                        <div id="recentActivities">
                            <div class="text-center py-4">
                                <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                                <p class="text-muted mt-2">Loading recent activities...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-bell me-2"></i>Notifications</h6>
                    </div>
                    <div class="card-body">
                        <div id="notifications">
                            <div class="text-center py-4">
                                <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                                <p class="text-muted mt-2">Loading notifications...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Modal -->
    <div class="modal fade" id="filterModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Dashboard Filters</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="dateRange" class="form-label">Date Range</label>
                        <select class="form-select" id="dateRange">
                            <option value="7">Last 7 Days</option>
                            <option value="30" selected>Last 30 Days</option>
                            <option value="90">Last 90 Days</option>
                            <option value="365">Last Year</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="departmentFilter" class="form-label">Department</label>
                        <select class="form-select" id="departmentFilter">
                            <option value="">All Departments</option>
                            <!-- Departments will be loaded dynamically -->
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Global variables
        let taskStatusChart, workflowStatusChart, taskTrendChart, priorityChart;
        let currentFilters = {
            dateRange: 30,
            department: ''
        };
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            loadDashboardData();
            loadRecentActivities();
            loadNotifications();
            
            // Auto-refresh every 30 seconds
            setInterval(loadDashboardData, 30000);
        });
        
        // Initialize charts
        function initializeCharts() {
            // Task Status Chart
            const taskStatusCtx = document.getElementById('taskStatusChart').getContext('2d');
            taskStatusChart = new Chart(taskStatusCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Pending', 'In Progress', 'Completed', 'On Hold', 'Cancelled'],
                    datasets: [{
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: ['#6c757d', '#007bff', '#28a745', '#ffc107', '#dc3545']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            // Workflow Status Chart
            const workflowStatusCtx = document.getElementById('workflowStatusChart').getContext('2d');
            workflowStatusChart = new Chart(workflowStatusCtx, {
                type: 'bar',
                data: {
                    labels: ['Draft', 'Active', 'Completed', 'Suspended', 'Archived'],
                    datasets: [{
                        label: 'Workflows',
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: ['#6c757d', '#28a745', '#007bff', '#ffc107', '#dc3545']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // Task Trend Chart
            const taskTrendCtx = document.getElementById('taskTrendChart').getContext('2d');
            taskTrendChart = new Chart(taskTrendCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Completed Tasks',
                        data: [],
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // Priority Chart
            const priorityCtx = document.getElementById('priorityChart').getContext('2d');
            priorityChart = new Chart(priorityCtx, {
                type: 'pie',
                data: {
                    labels: ['Low', 'Medium', 'High', 'Urgent'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: ['#17a2b8', '#ffc107', '#fd7e14', '#dc3545']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function populateDepartmentDropdown(departments) {
            debugger
            const departmentFilter = document.getElementById('departmentFilter');
            departmentFilter.innerHTML = '<option value="">All Departments</option>';
            
            if (departments && departments.length > 0) {
                departments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept.id;
                    option.textContent = dept.name;
                    departmentFilter.appendChild(option);
                });
            } else {
                populateFallbackDepartments();
            }
        }
        
        function populateFallbackDepartments() {
            console.log('Using fallback departments');
            const departmentFilter = document.getElementById('departmentFilter');
            departmentFilter.innerHTML = '<option value="">All Departments</option>';
            
            const fallbackDepartments = [
                { id: 1, name: 'Information Technology' },
                { id: 2, name: 'Human Resources' },
                { id: 3, name: 'Finance' },
                { id: 4, name: 'Marketing' }
            ];
            
            fallbackDepartments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept.id;
                option.textContent = dept.name;
                departmentFilter.appendChild(option);
            });
        }
        
        // Load dashboard data with filters
        function loadDashboardData() {
            const params = new URLSearchParams();
            if (currentFilters.dateRange) {
                params.append('dateRange', currentFilters.dateRange);
            }
            if (currentFilters.department) {
                params.append('department', currentFilters.department);
            }
            
            const url = '/dashboard/api/statistics' + (params.toString() ? '?' + params.toString() : '');
            
            $.ajax({
                type: "GET",
                url: url,
                dataType: "json",
                success: function (data) {
                    console.log('Dashboard data loaded successfully:', data);
                    updateStatistics(data);
                    updateCharts(data);
                    populateDepartmentDropdown(data.getDepartmentsForDashboard);
                },
                error: function (xhr, status, error) {
                    console.error('Error loading dashboard data:', error);
                    console.error('Status:', status);
                    console.error('XHR:', xhr);
                    showErrorMessage('Failed to load dashboard data. Please try again.');
                }
            });
        }
        
        // Update statistics cards
        function updateStatistics(data) {
            document.getElementById('totalWorkflows').textContent = data.totalWorkflows || 0;
            document.getElementById('totalTasks').textContent = data.totalTasks || 0;
            document.getElementById('pendingTasks').textContent = data.pendingTasks || 0;
            document.getElementById('overdueTasks').textContent = data.overdueTasks || 0;
        }
        
        // Update charts with data
        function updateCharts(data) {
            // Update task status chart
            if (data.taskStatusStats) {
                taskStatusChart.data.datasets[0].data = data.taskStatusStats.map(stat => stat[1]);
                taskStatusChart.update();
            }
            
            // Update workflow status chart
            if (data.workflowStatusStats) {
                workflowStatusChart.data.datasets[0].data = data.workflowStatusStats.map(stat => stat[1]);
                workflowStatusChart.update();
            }
            
            // Update task trend chart
            if (data.taskTrendData) {
                taskTrendChart.data.labels = data.taskTrendData.labels;
                taskTrendChart.data.datasets[0].data = data.taskTrendData.data;
                taskTrendChart.update();
            }
            
            // Update priority chart
            if (data.priorityStats) {
                priorityChart.data.datasets[0].data = data.priorityStats.map(stat => stat[1]);
                priorityChart.update();
            }
        }
        
        // Load recent activities
        function loadRecentActivities() {
            $.ajax({
                type: "GET",
                url: "/dashboard/api/audit/recent",
                dataType: "json",
                success: function (data) {
                    console.log('Recent activities loaded successfully:', data);
                    const activitiesHtml = data.map(activity => `
                        <div class="notification-item">
                            <div class="d-flex justify-content-between">
                                <strong>${activity.action}</strong>
                                <small class="text-muted">${formatDate(activity.timestamp)}</small>
                            </div>
                            <p class="mb-0 text-muted">${activity.description}</p>
                        </div>
                    `).join('');
                    
                    document.getElementById('recentActivities').innerHTML = activitiesHtml ||
                        '<p class="text-muted text-center">No recent activities found.</p>';
                },
                error: function (xhr, status, error) {
                    console.error('Error loading recent activities:', error);
                    console.error('Status:', status);
                    console.error('XHR:', xhr);
                    document.getElementById('recentActivities').innerHTML =
                        '<p class="text-danger text-center">Error loading activities.</p>';
                }
            });
        }
        
        // Load notifications
        function loadNotifications() {
            $.ajax({
                type: "GET",
                url: "/dashboard/api/notifications",
                dataType: "json",
                success: function (data) {
                    console.log('Notifications loaded successfully:', data);
                    const notificationsHtml = data.map(notification => `
                        <div class="notification-item ${notification.type === 'URGENT' ? 'urgent' : notification.type === 'SUCCESS' ? 'success' : ''}">
                            <div class="d-flex justify-content-between">
                                <strong>${notification.title}</strong>
                                <small class="text-muted">${formatDate(notification.timestamp)}</small>
                            </div>
                            <p class="mb-0">${notification.message}</p>
                        </div>
                    `).join('');
                    
                    document.getElementById('notifications').innerHTML = notificationsHtml ||
                        '<p class="text-muted text-center">No new notifications.</p>';
                },
                error: function (xhr, status, error) {
                    console.error('Error loading notifications:', error);
                    console.error('Status:', status);
                    console.error('XHR:', xhr);
                    document.getElementById('notifications').innerHTML =
                        '<p class="text-danger text-center">Error loading notifications.</p>';
                }
            });
        }
        
        // Refresh dashboard
        function refreshDashboard() {
            // Show loading indicators
            document.getElementById('recentActivities').innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                    <p class="text-muted mt-2">Loading recent activities...</p>
                </div>
            `;
            
            document.getElementById('notifications').innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                    <p class="text-muted mt-2">Loading notifications...</p>
                </div>
            `;
            
            loadDashboardData();
            loadRecentActivities();
            loadNotifications();
        }
        
        // Apply filters
        function applyFilters() {
            const dateRange = document.getElementById('dateRange').value;
            const department = document.getElementById('departmentFilter').value;
            
            // Update current filters
            currentFilters.dateRange = dateRange;
            currentFilters.department = department;
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('filterModal'));
            modal.hide();
            
            // Reload data with filters
            refreshDashboard();
        }
        
        // Show error message
        function showErrorMessage(message) {
            const alertHtml = `
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            // Insert at the top of the container
            const container = document.querySelector('.container');
            container.insertAdjacentHTML('afterbegin', alertHtml);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                const alert = container.querySelector('.alert');
                if (alert) {
                    alert.remove();
                }
            }, 5000);
        }
        
        // Format date helper
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString();
        }
        
        // Navigate to different pages
        function navigateToPage(url) {
            console.log('Navigating to:', url);
            window.location.href = url;
        }
    </script>
</body>
</html>